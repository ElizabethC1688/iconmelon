(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("views/IconSelectView",["views/ProtoView","collectionViews/SectionsCollectionView","collections/SectionsCollection","collectionViews/FiltersCollectionView","collections/FiltersCollection","fileupload","underscore","jquery","helpers"],function(e,n,r,i,s,o,u,a,f){var l,c;return l=function(e){function o(){return c=o.__super__.constructor.apply(this,arguments),c}return t(o,e),o.prototype.template="#icon-select-view-template",o.prototype.className="",o.prototype.events={keyup:"debouncedFilter","click #js-add-effects":"toggleEffects","click #js-next":"next","click #js-prev":"prev","click #js-page":"loadPage"},o.prototype.initialize=function(e){return this.o=e!=null?e:{},this.paginationTemplate=u.template(f.unescape(a("#pagination-template").text())),this.buttonCounterTemplate=u.template(f.unescape(a("#button-counter-template").text())),this.bindModelEvents(),this.debouncedFilter=u.debounce(this.filter,250),o.__super__.initialize.apply(this,arguments),this.sectionsCollection.on("afterFetch",u.bind(this.renderPagination,this)),this},o.prototype.next=function(){var e=this;return this.changePageNoty(),u.defer(function(){return e.sectionsCollection.nextPage()})},o.prototype.prev=function(){var e=this;return this.changePageNoty(),u.defer(function(){return e.sectionsCollection.prevPage()})},o.prototype.scrollTop=function(){return App.$bodyHtml.animate({scrollTop:this.$el.position().top})},o.prototype.showLoader=function(){return f.showLoaderLine("is-long").setLoaderLineProgress(100)},o.prototype.changePageNoty=function(){return this.showLoader(),this.scrollTop()},o.prototype.loadPage=function(e){return this.changePageNoty(),this.sectionsCollection.loadPage(parseInt(a(e.target).text(),10)||0)},o.prototype.toggleEffects=function(){return this.$("#js-filter-block").show().addClass("animated fadeInDown").find("#js-filters-place").trigger("show"),this.$el.addClass("is-filter-show")},o.prototype.filter=function(e){return App.vent.trigger("icon-select-filter:change",a.trim(a(e.target).val()))},o.prototype.bindModelEvents=function(){return this.model.on("change:selectedCounter",u.bind(this.renderButton,this))},o.prototype.render=function(){return o.__super__.render.apply(this,arguments),this.renderView(),this.$paginationPlace=this.$("#js-pagination-place"),this.renderButton(),this.initFileUpload(),this},o.prototype.renderPagination=function(){var e=this;return f.hideLoaderLine("is-long"),this.checkSelectedSections(),App.router.navigate(this.sectionsCollection.options.page!==0?"#/page-"+this.sectionsCollection.options.page:"#/page-loaded"),u.defer(function(){return e.$paginationPlace.html(e.paginationTemplate(e.sectionsCollection.pageInfo()))})},o.prototype.renderView=function(){var e=this;return this.filtersCollectionView=new i({collection:new s,isRender:!0,$el:this.$("#js-filters-place")}),this.filtersCollectionView.collection.fetch().then(function(){return e.filtersCollectionView.collection.addSvgFilters()}),this.sectionsCollection=new r({isPaginated:!0,pageNum:this.o.pageNum}),this.sectionsCollection.fetch().then(function(){if(e.isClosed)return;return e.$("#js-loader").fadeOut("fast",function(){return e.sectionsCollection.generateSvgData(),e.sectionsCollectionView=new n({collection:e.sectionsCollection,isRender:!0,$el:e.$("#js-section-collections-place")}),e.renderPagination(),App.sectionsCollectionView=e.sectionsCollectionView,e.model.sectionsView=e.sectionsCollectionView})}),this},o.prototype.renderButton=function(){return this.$("#js-counter-btn-place").html(this.buttonCounterTemplate(this.model.toJSON()))},o.prototype.initFileUpload=function(){var e=this;return this.$("#fileupload").fileupload({url:"/file-upload",acceptFileTypes:/(\.|\/)(svg)$/i,dataType:"text",limitMultiFileUploads:999,add:function(t,n){return e.filesDropped=n.originalFiles.length,e.filesLoaded=0,n.submit()},done:function(t,n){return e.filesLoaded++,e.parseFile(n.result),e.filesLoaded===e.filesDropped&&e.finishFilesLoading()},error:function(e,t){return App.notifier.show({text:"loading error",type:"error"})},progressall:function(e,t){var n;return n=parseInt(t.loaded/t.total*100,10),App.$loadingLine.css({width:""+n+"%"})}})},o.prototype.finishFilesLoading=function(){var e=this;return setTimeout(function(){return App.$loadingLine.fadeOut(100,function(){return App.$loadingLine.width("0%"),App.$loadingLine.show()})},2e3)},o.prototype.parseFile=function(e){var t,n,r,i,s,o,a,f,l;r=e.match(/(data\-iconmelon\s?=\s?\")(.+?)\"/gi),s={},i=[];for(t=o=0,a=r.length;o<a;t=++o)n=r[t],n=n.split("data-iconmelon")[1].replace(/[\"\=]/gi,""),n=n.split(":"),(l=s[f=n[0]])==null&&(s[f]=[]),s[n[0]].push(n[1]),i.push(n[0]);return this.checkLoadedIcons(s,u.uniq(i))},o.prototype.checkSelectedSections=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h;o={},l=App.iconsSelected;for(e=u=0,a=l.length;u<a;e=++u)t=l[e],t=t.split(":"),(c=o[f=t[0]])==null&&(o[f]=[]),o[t[0]].push(t[1]);h=[];for(s in o)n=o[s],h.push(function(){var o,u,a;a=[];for(e=o=0,u=n.length;o<u;e=++o)t=n[e],a.push(function(){var e,n,o,u,a,f;o=this.sectionsCollection.where({name:s}),f=[];for(r=e=0,n=o.length;e<n;r=++e)i=o[r],f.push((u=i.iconsCollection.where({hash:t}))!=null?(a=u[0])!=null?a.set("isSelected",!0):void 0:void 0);return f}.call(this));return a}.call(this));return h},o.prototype.checkLoadedIcons=function(e,t){var n=this;return this.loadSections(t).then(function(){var t,r,i,s,o,u,a,f,l;l=[];for(f in e)s=e[f],f!=="filter"?(a=n.sectionsCollectionView.collection.where({name:f}),l.push(function(){var e,t,n;n=[];for(r=e=0,t=a.length;e<t;r=++e)u=a[r],n.push(function(){var e,t,n,r,a;a=[];for(o=e=0,t=s.length;e<t;o=++e)i=s[o],a.push((n=u.iconsCollection.where({hash:i}))!=null?(r=n[0])!=null?r.select():void 0:void 0);return a}());return n}())):l.push(function(){var e,n,i,o,u;u=[];for(r=e=0,n=s.length;e<n;r=++e)t=s[r],u.push((i=this.filtersCollectionView.collection.where({hash:t}))!=null?(o=i[0])!=null?o.set("isSelected",!0):void 0:void 0);return u}.call(n));return l})},o.prototype.loadSections=function(e){var t=this;return this.sectionsCollection.fetch({sectionNames:e}).then(function(){return t.sectionsCollection.generateSvgData(),t.sectionsCollection.options.page=0,t.sectionsCollection.options.sectionNames=null,t.renderPagination()})},o.prototype.teardown=function(){var e;return f.hideLoaderLine("is-long"),(e=this.sectionsCollectionView)!=null&&e.teardown(),o.__super__.teardown.apply(this,arguments)},o}(e),l})}).call(this);