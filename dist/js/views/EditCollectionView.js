(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("views/EditCollectionView",["views/ProtoView","views/IconEditView","collections/IconsCollection","collectionViews/IconsCollectionView","views/ThanxModalView","fileupload","jquery","helpers"],function(e,n,r,i,s,o,u,a){var f,l;return f=function(e){function o(){return l=o.__super__.constructor.apply(this,arguments),l}return t(o,e),o.prototype.template="#edit-collection-view-template",o.prototype.events={"click #js-add-icon":"addIcon","click .js-submit-btn:not(.is-inactive)":"submit","click .js-submit-btn.is-inactive":"suggestOnSubmition","click .js-delete":"delete","click .js-save":"save"},o.prototype.bindings={"#js-collection-name":{observe:"name",onSet:"nameSet"},"#js-author":{observe:"author",onSet:"authorSet"},"#js-license":{observe:"license",onSet:"licenseSet"},"#js-agree input":{observe:"isAgree",onSet:"agreeSet"},"#js-email":{observe:"email",onSet:"emailSet"},"#js-website":"website","#js-moderated input":"moderated","#js-multicolor  input":{observe:"isMulticolor",onSet:"multicolorChange"}},o.prototype.ui={submitBtn:".js-submit-btn"},o.prototype.initialize=function(e){return this.o=e!=null?e:{},o.__super__.initialize.apply(this,arguments),this.iconsLoaded=[],this.o.mode==="edit"&&this.makeSvgData(),this.initFileUpload(),this},o.prototype.render=function(){return o.__super__.render.apply(this,arguments),this.$submitButton=this.$(this.ui.submitBtn),this.o.mode==="edit"&&this.$(".collection-credits-b").addClass("is-edit"),this.renderIconsCollection(),this.stickit(),this},o.prototype.multicolorChange=function(e){var t=this;return _.defer(function(){return t.makeSvgData(!1,!0),_.defer(function(){return t.renderIcons()})}),e},o.prototype.renderIcons=function(){var e,t,n,r,i,s;i=this.iconsCollection.children.toArray(),s=[];for(e=n=0,r=i.length;n<r;e=++n)t=i[e],s.push(t.render());return s},o.prototype.suggestOnSubmition=function(e){return App.notifier.show({type:"error",text:"You have to fill credentials, agree to the terms of service and have at least one valid icon to make this button active"})},o.prototype.makeSvgData=function(e,t){var n=this;return e==null&&(e=!0),t==null&&(t=!1),console.time("svg load"),this.$shapes=u("<div>"),this.iconsCollection.collection.each(function(r){return a.upsetSvgShape({hash:r.get("hash"),$shapes:n.$shapes,shape:r.get("shape"),isCheck:e,isMulticolor:n.model.get("isMulticolor"),isReset:t})}),a.addToSvg(this.$shapes),console.timeEnd("svg load")},o.prototype.renderIconsCollection=function(){return this.iconsCollection=new i({itemView:n,collection:new r(this.model.get("icons").length?this.model.get("icons"):[{}]),isRender:!0,$el:this.$("#js-icons-place"),mode:this.o.mode}),this.iconsCollection.collection.parentModel=this.model,App.vent.on("edit-collection:change",_.bind(this.checkIfValidCollection,this))},o.prototype.addIcon=function(){return this.iconsCollection.collection.add({})},o.prototype.nameSet=function(e){return this.nameValid=u.trim(e.length)<1?!1:!0,this.$("#js-collection-name").toggleClass("is-error",!this.nameValid),this.checkIfValidCollection(),e},o.prototype.authorSet=function(e){return this.authorValid=u.trim(e.length)<3?!1:!0,this.$("#js-author").toggleClass("is-error",!this.authorValid),this.checkIfValidCollection(),e},o.prototype.emailSet=function(e){var t;return t=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,this.emailValid=t.test(e),this.$("#js-email").toggleClass("is-error",!this.emailValid),this.checkIfValidCollection(),e},o.prototype.licenseSet=function(e){return this.licenseValid=u.trim(e).length>=3,this.$("#js-license").toggleClass("is-error",!this.licenseValid),this.checkIfValidCollection(),e},o.prototype.agreeSet=function(e){return this.isAgree=e,this.checkIfValidCollection(),e},o.prototype.checkIfValidCollection=function(){return this.enableSubmitButton(this.isAgree&&this.nameValid&&this.authorValid&&this.emailValid&&this.licenseValid&&this.isValidCollection())},o.prototype.isValidCollection=function(){var e,t;e=0,t=!1;while(e<this.iconsCollection.collection.models.length)this.iconsCollection.collection.at(e).get("isValid")&&(e=this.iconsCollection.collection.models.length,t=!0),e++;return t},o.prototype.enableSubmitButton=function(e){return this.$submitButton.toggleClass("is-inactive",!e)},o.prototype.submit=function(){var e=this;return this.$submitButton.addClass("loading-eff is-inactive"),_.defer(function(){return e.model.set("icons",e.iconsCollection.collection.toJSON()),e.model.save().then(function(){return e.$submitButton.removeClass("loading-eff"),(new s).onClose=function(){}}).fail(function(t){return e.$submitButton.removeClass("loading-eff is-inactive")})})},o.prototype["delete"]=function(){if(confirm("Are you sure?"))return this.model.destroy()},o.prototype.save=function(){var e=this;return _.defer(function(){return e.model.set("icons",e.iconsCollection.collection.toJSON()),e.model.save().done(function(){return App.notifier.show({type:"ok",text:"saved happily",delay:4e3})}).fail(function(){return App.notifier.show({type:"error",text:"saving sadness",delay:4e3})})})},o.prototype.initFileUpload=function(){var e=this;return this.$("#fileupload").fileupload({url:"/file-upload",acceptFileTypes:/(\.|\/)(svg)$/i,dataType:"text",limitMultiFileUploads:999,add:function(t,n){return e.filesDropped=n.originalFiles.length,e.filesLoaded=0,n.submit()},done:function(t,n){var r;return e.filesLoaded++,r=n.files[0].name.split(".svg")[0],n={shape:n.result,name:r!=null?r.toLowerCase():void 0,hash:a.generateHash(),isValid:!0},e.iconsLoaded.push(n),e.filesLoaded===e.filesDropped&&e.finishFilesLoading()},error:function(e,t){return App.notifier.show({text:"loading error",type:"error"})},progressall:function(e,t){var n;return n=parseInt(t.loaded/t.total*100,10),App.$loadingLine.css({width:""+n+"%"})}})},o.prototype.finishFilesLoading=function(){var e,t=this;return this.modelToRemove=this.iconsCollection.collection.length===1&&!this.isValidCollection()?this.iconsCollection.collection.at(0):null,this.iconsCollection.collection.mode="edit",this.iconsCollection.collection.add(this.iconsLoaded),(e=this.modelToRemove)!=null&&e.destroy(),this.iconsLoaded=[],this.makeSvgData(!1),this.checkIfValidCollection(),_.defer(function(){return App.$loadingLine.fadeOut(100,function(){return App.$loadingLine.width("0%"),App.$loadingLine.show()})})},o}(e),f})}).call(this);